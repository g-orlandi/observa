{% extends "frontend/base.html" %}
{% block content %}

{# Selettore dinamico in base all'URL #}
{% if request.resolver_match.url_name == "network" %}
    {% include "frontend/components/endpoint_select.html" %}
{% elif request.resolver_match.url_name in "resources backup" %}
    {% include "frontend/components/server_select.html" %}
{% endif %}

<div class="container mt-4">
  <div class="row text-center g-3">
    <h2>Actual values</h2>

    {% block actual_values %}
    <div class="row g-3 justify-content-center text-center">
      {% for w in widgets %}
      <div class="col-md-{{ w.col|default:2 }}">
        <div class="p-3 bg-light border rounded shadow-sm h-100">
          <div class="text-muted small mb-1">
            <i class="bi {{ w.icon }}"></i> {{ w.title }}
          </div>
          <div class="fs-4 fw-bold text-dark">

            {# Risoluzione URL in base a metric #}
            {% if w.metric %}
              {% url w.url_name metric=w.metric as widget_url %}
            {% else %}
              {% url w.url_name as widget_url %}
            {% endif %}

            {# Costruzione dell'hx-get finale #}
            {% if w.source %}
              {% with widget_url|add:"?source="|add:w.source as final_url %}
                <span 
                  hx-get="{{ final_url }}" 
                  hx-trigger="{{ w.trigger|default:'load' }}" 
                  hx-swap="outerHTML"
                  class="d-inline-block">
                  ?
                </span>
              {% endwith %}
            {% else %}
              <span 
                hx-get="{{ widget_url }}" 
                hx-trigger="{{ w.trigger|default:'load' }}" 
                hx-swap="outerHTML"
                class="d-inline-block">
                ?
              </span>
            {% endif %}

            {% if w.unit %}
              <small class="text-muted">{{ w.unit }}</small>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endblock actual_values %}
  </div>
</div>

<hr class="mt-4 mb-3">

<div class="container mb-4">
  <h2 class="text-center">Historical values</h2>
  <form id="data-range-form" method="POST" action="{% url 'users:set_date_range' %}" class="row g-2 align-items-center justify-content-start">
    {% csrf_token %}
    <div class="col-auto">
      <label for="start-date" class="col-form-label small mb-0">From:</label>
    </div>
    <div class="col-auto">
      <input type="date" id="start-date" name="start_date" class="form-control form-control-sm"
             value="{{ request.user.get_active_date_filters.date_from|date:'Y-m-d' }}">
    </div>
    <div class="col-auto">
      <label for="end-date" class="col-form-label small mb-0">To:</label>
    </div>
    <div class="col-auto">
      <input type="date" id="end-date" name="end_date" class="form-control form-control-sm"
             value="{{ request.user.get_active_date_filters.date_to|date:'Y-m-d' }}">
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-sm btn-primary">Apply</button>
    </div>
  </form>
</div>

<div id="graphs-container">
  {% include graph_include %}
</div>

{% endblock content %}
